{% load static %}


<!DOCTYPE html>
<html lang="ne">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>राष्ट्रिय जीवन बीमा कम्पनी लिमिटेड | KYC Form</title>

  <!-- ✅ Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- ✅ Nepali Datepicker -->
  <link href="https://nepalidatepicker.sajanmaharjan.com.np/v5/nepali.datepicker/css/nepali.datepicker.v5.0.6.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://nepalidatepicker.sajanmaharjan.com.np/v5/nepali.datepicker/js/nepali.datepicker.v5.0.6.min.js"></script>

 <!-- ✅ Add this line for offline BS <-> AD conversion -->
  <script src="{% static 'js/nepaliFunctions_local.js' %}"></script>

  <style>
    body { background:#f8fafc; font-family:"Segoe UI",Arial,sans-serif; }
    .form-section { background:#fff; border-radius:10px; padding:25px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .section-title { color:#0d6efd; font-weight:600; margin-top:25px; border-bottom:2px solid #0d6efd; display:inline-block; }
    label { font-weight:500; }
    .is-invalid { border-color:red; }
  </style>
</head>

<body>
  <div class="container mt-4 mb-5" style="max-width:1100px;">
    <div class="text-center mb-3 border-bottom pb-2">
      <img src="{% static 'images/rjbclogo.png' %}" 
     alt="Rastriya Jeeewan Beema Logo" 
     style="height:90px;">
      <h4 class="mt-2 fw-bold text-primary">राष्ट्रिय जीवन बीमा कम्पनी लिमिटेड</h4>
      <h6 class="text-secondary">Rastriya Jeeewan Beema Company Limited</h6>
      <p class="small mb-0">Know Your Customer (KYC) Update Form</p>
    </div>

    <form id="kycForm" method="POST" action="{% url 'kyc_form' %}">
  {% csrf_token %}

<input type="hidden" name="policy_no" id="policyField">
	<!-- Display Policy Number -->
<div class="mb-3">
    <label class="form-label fw-bold">Policy Number</label>
    <input type="text" id="policyVisible" class="form-control bg-light" readonly style="font-weight:600;">
</div>


      <!-- Personal Information -->
      <h5 class="section-title">१. व्यक्तिगत विवरण / Personal Information</h5>
      <div class="row">
        <div class="col-md-3 mb-3">
          <label>पहिलो नाम / First Name</label>
          <input type="text" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>थर / Last Name</label>
          <input type="text" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>लिङ्ग / Gender</label>
          <select class="form-select form-select-sm" required>
            <option value="">Select</option>
            <option>Male</option><option>Female</option><option>Other</option>
          </select>
        </div>
        <div class="col-md-3 mb-3">
          <label>वैवाहिक स्थिति / Marital Status</label>
          <select class="form-select form-select-sm" required>
            <option value="">Select</option>
            <option>Married</option><option>Unmarried</option><option>Divorced</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div class="col-md-3 mb-3">
          <label>जन्म मिति (BS)</label>
          <input type="text" id="dob_bs" class="form-control form-control-sm" autocomplete="off" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>Date of Birth (AD)</label>
          <input type="date" id="dob_ad" class="form-control form-control-sm" required>
        </div>
        <div class="col-md-3 mb-3">
          <label>Nationality</label>
          <input type="text" value="Nepalese" class="form-control form-control-sm">
        </div>
      </div>

      <!-- Identification Section -->
      <h5 class="section-title">२. परिचयपत्र विवरण / Identification Documents</h5>
      <h6 class="fw-semibold text-secondary">A. Citizenship Details</h6>
      <div class="row">
        <div class="col-md-3 mb-3"><label>Citizenship No</label><input type="text" class="form-control form-control-sm" required></div>
        <div class="col-md-3 mb-3"><label>Issued District</label><input type="text" class="form-control form-control-sm" required></div>
        <div class="col-md-3 mb-3"><label>Issued Date (BS)</label><input type="text" id="citizen_bs" class="form-control form-control-sm" autocomplete="off" required></div>
        <div class="col-md-3 mb-3"><label>Citizenship Copy Upload</label><input type="file" class="form-control form-control-sm" required></div>
      </div>

      <h6 class="fw-semibold text-secondary">B. National ID Details</h6>
      <div class="row">
        <div class="col-md-3 mb-3"><label>NID Number</label><input type="text" class="form-control form-control-sm" required></div>
        <div class="col-md-3 mb-3"><label>Issued Date (BS)</label><input type="text" id="nid_bs" class="form-control form-control-sm" autocomplete="off" required></div>
        <div class="col-md-3 mb-3"><label>Issued District</label><input type="text" class="form-control form-control-sm" required></div>
        <div class="col-md-3 mb-3"><label>NID Card Upload</label><input type="file" class="form-control form-control-sm" required></div>
      </div>

      <!-- Address -->
      <h5 class="section-title">३. ठेगाना विवरण / Address Details</h5>
      <h6>स्थायी ठेगाना (Permanent Address)</h6>
      <div class="row">
        <div class="col-md-3 mb-3"><label>Province</label><select id="perm_province" class="form-select form-select-sm" required></select></div>
        <div class="col-md-3 mb-3"><label>District</label><select id="perm_district" class="form-select form-select-sm" required></select></div>
        <div class="col-md-3 mb-3"><label>Municipality</label><select id="perm_muni" class="form-select form-select-sm" required></select></div>
        <div class="col-md-3 mb-3"><label>Ward</label><input type="number" class="form-control form-control-sm" required></div>
      </div>

      <h6>अस्थायी ठेगाना (Temporary Address)</h6>
      <div class="row">
        <div class="col-md-3 mb-3"><label>Province</label><select id="temp_province" class="form-select form-select-sm" required></select></div>
        <div class="col-md-3 mb-3"><label>District</label><select id="temp_district" class="form-select form-select-sm" required></select></div>
        <div class="col-md-3 mb-3"><label>Municipality</label><select id="temp_muni" class="form-select form-select-sm" required></select></div>
        <div class="col-md-3 mb-3"><label>Ward</label><input type="number" class="form-control form-control-sm" required></div>
      </div>

      <!-- Occupation -->
      <h5 class="section-title">४. पेशा / Occupation Details</h5>
      <div class="row">
        <div class="col-md-4 mb-3">
          <label>Occupation</label>
          <select class="form-select form-select-sm" required>
            <option value="">Select</option>
            <option>Government Service</option><option>Private Job</option><option>Business</option>
            <option>Agriculture</option><option>Housewife</option><option>Student</option><option>Other</option>
          </select>
        </div>
        <div class="col-md-4 mb-3"><label>PAN Number</label><input type="text" class="form-control form-control-sm"></div>
        <div class="col-md-4 mb-3"><label>Annual Income (Rs.)</label><input type="number" class="form-control form-control-sm"></div>
      </div>

      <!-- Photo and Signature -->
      <h5 class="section-title">५. फोटो र हस्ताक्षर / Photo & Signature</h5>
      <div class="row">
        <div class="col-md-6 mb-3"><label>Upload Photo</label><input type="file" class="form-control form-control-sm" accept="image/*" required></div>
        <div class="col-md-6 mb-3"><label>Upload Signature</label><input type="file" class="form-control form-control-sm" accept="image/*" required></div>
      </div>

      <!-- Declaration -->
      <h5 class="section-title">६. घोषणा / Declaration</h5>
      <div class="mb-3">
        <label>के तपाईँले दिएको विवरण सत्य र ठ्याक्कै हो?</label><br>
        <input type="radio" name="declaration" value="Yes" required> हो / Yes
        <input type="radio" name="declaration" value="No"> होइन / No
      </div>

      <div class="text-center mt-4">
        <button type="submit" class="btn btn-success px-5">पेश गर्नुहोस् / Submit</button>
      </div>
    </form>
    <p class="text-center mt-3 text-muted small">© Rastriya Jeeewan Beema Company Limited</p>
  </div>

  <script>
$(function(){

  // =============================
  // 1. Initialize Datepickers
  // =============================
  $("#dob_bs, #citizen_bs, #nid_bs").nepaliDatePicker({
    ndpYear:true,
    ndpMonth:true,
    ndpYearCount:120
  });

  // =============================
  // 2. BS ↔ AD Conversion Logic
  // =============================

  const nepaliDigits = {'०':'0','१':'1','२':'2','३':'3','४':'4','५':'5','६':'6','७':'7','८':'8','९':'9'};
  function nepaliToLatin(s){return s?s.replace(/[०१२३४५६७८९]/g,d=>nepaliDigits[d]||d):s;}

  function normalizeBS(bsRaw){
    if(!bsRaw) return '';
    let s = nepaliToLatin(bsRaw.trim()).replace(/\s+/g,'').replace(/[^\d\-\/]/g,'').replace(/\//g,'-');
    if(/^\d{8}$/.test(s)) return `${s.slice(0,4)}-${s.slice(4,6)}-${s.slice(6,8)}`;
    const parts = s.split('-').filter(Boolean);
    if(parts.length===3){
      const [y,m,d]=parts;
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    return '';
  }

  function bsToAd(bsRaw){
    try{
      const n = normalizeBS(bsRaw);
      if(!n) return '';
      const [y,m,d] = n.split('-').map(Number);
      const ad = NepaliFunctions.BS2AD({year:y,month:m,day:d});
      return `${ad.year}-${String(ad.month).padStart(2,'0')}-${String(ad.day).padStart(2,'0')}`;
    }catch(e){console.error("BS→AD error",e);return'';}
  }

  function adToBs(adRaw){
    try{
      const [y,m,d] = adRaw.split('-').map(Number);
      const bs = NepaliFunctions.AD2BS({year:y,month:m,day:d});
      return `${bs.year}-${String(bs.month).padStart(2,'0')}-${String(bs.day).padStart(2,'0')}`;
    }catch(e){console.error("AD→BS error",e);return'';}
  }

  const $bs = $("#dob_bs");
  const $ad = $("#dob_ad");

  // Convert BS → AD (handles typing or datepicker)
  function updateAD(){
    const ad = bsToAd($bs.val());
    if(ad) $ad.val(ad);
  }

  // Convert AD → BS
  $ad.on("change blur",function(){
    const bs = adToBs($(this).val());
    if(bs) $bs.val(bs);
  });

  // Observe changes from the datepicker (handles clicks)
  const observer = new MutationObserver(() => updateAD());
  observer.observe($bs[0], {attributes:true, attributeFilter:['value']});
  $bs.on("input change blur", updateAD);

  console.log("✅ BS↔AD conversion active");

  // =============================
  // 3. Dynamic Address Loading
  // =============================
  function initWithLocations(locations){
    function populateProvince(sel){sel.html('<option value="">Select Province</option>');for(let p in locations){sel.append(`<option>${p}</option>`);}}
    function populateDistricts(p,selD,selM){selD.html('<option value="">Select District</option>');selM.html('<option value="">Select Municipality</option>');if(locations[p])Object.keys(locations[p]).forEach(d=>selD.append(`<option>${d}</option>`));}
    function populateMunicipalities(p,d,selM){selM.html('<option value="">Select Municipality</option>');if(locations[p]&&locations[p][d])locations[p][d].forEach(m=>selM.append(`<option>${m}</option>`));}
    populateProvince($('#perm_province'));populateProvince($('#temp_province'));
    $('#perm_province').on('change',function(){populateDistricts($(this).val(),$('#perm_district'),$('#perm_muni'));});
    $('#perm_district').on('change',function(){populateMunicipalities($('#perm_province').val(),$(this).val(),$('#perm_muni'));});
    $('#temp_province').on('change',function(){populateDistricts($(this).val(),$('#temp_district'),$('#temp_muni'));});
    $('#temp_district').on('change',function(){populateMunicipalities($('#temp_province').val(),$(this).val(),$('#temp_muni'));});
  }

  $.getJSON('/static/nepal_locations.json')
    .done(function(data){
      console.log('✅ Loaded full Nepal location data');
      initWithLocations(data);
    })
    .fail(function(){
      alert('⚠️ Could not load nepal_locations.json');
    });

  // =============================
  // 4. Form Validation
  // =============================
 $("#kycForm").on("submit",function(e){

    let valid = true;

    $(this).find("[required]").each(function(){
        if(!$(this).val()){
            valid = false;
            $(this).addClass("is-invalid");
        } else {
            $(this).removeClass("is-invalid");
        }
    });

    // ❌ BLOCK ONLY IF INVALID
    if(!valid){
        e.preventDefault();
        alert("कृपया सबै आवश्यक विवरण भर्नुहोस्। / Please fill all required fields.");
    }

    // ✔ If valid → allow natural form submit (NO e.preventDefault)
});


});
</script>

<script>
  const params = new URLSearchParams(window.location.search);
  const policy = params.get("policy_no");

  if (policy) {
      document.getElementById("policyVisible").value = policy;  // visible field
      document.getElementById("policyField").value = policy;    // hidden field for backend
  }
</script>


</body>
</html>
